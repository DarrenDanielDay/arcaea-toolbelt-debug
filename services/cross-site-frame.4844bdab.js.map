{"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAM,SAAU,0CAAS,GAAW,EAAE,QAAgB;IACpD,MAAM,OAAO,SAAS,aAAa,CAAC;IACpC,KAAK,QAAQ,GAAG;IAChB,KAAK,IAAI,GAAG;IACZ,KAAK,KAAK;AACZ;AAEM,SAAU,0CAAa,IAAY,EAAE,QAAgB;IACzD,MAAM,MAAM,IAAI,eAAe,CAAC,IAAI,KAAK;QAAC,KAAK,SAAS,CAAC,MAAM,WAAW,KAAK;KAAK,EAAE;QAAE,MAAM;IAAkB;IAChH,0CAAS,KAAK;AAChB;;;;AEVA,OAAO,QAAQ,IAAE,OAAO,cAAc,CAAC,QAAO,YAAW;IAAC,OAAM,OAAO;AAAkB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ADgBzF,MAAM,kCAAY,IAAI,CAAA,GAAA,gBAAA;AACtB,gCAAU,QAAQ,CAAC,CAAA,GAAA,oCAAA;AACnB,gCAAU,QAAQ,CAAC,CAAA,GAAA,uBAAA;AACnB,gCAAU,QAAQ,CAAC,CAAA,GAAA,yBAAA;AACnB,gCAAU,QAAQ,CAAC,CAAA,GAAA,0BAAA;AACnB,gCAAU,QAAQ,CAAC,CAAA,GAAA,2BAAA;AACnB,gCAAU,QAAQ,CAAC,CAAA,GAAA,mBAAA;AACnB,gCAAU,QAAQ,CAAC,CAAA,GAAA,4BAAA;AACnB,gCAAU,QAAQ,CAAC,CAAA,GAAA,yBAAA;AACnB,gCAAU,QAAQ,CAAC,CAAA,GAAA,2BAAA;AAEnB,MAAM,gCAAU,gCAAU,GAAG,CAAC,CAAA,GAAA,sBAAA;AAC9B,yBAAyB;AACzB;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA4BE,GACF,YAAY;AAEZ,MAAM,gDAA0B,CAAC;IAC/B,OAAO,QAAQ,QAAQ,OAAO,SAAS,YAAY,UAAU,QAAQ,aAAa;AACpF;AAEA;;CAEG,GACH,MAAM,kCAAY;IAChB,MAAM,MAAM,IAAI,IAAI,SAAS,IAAI;IACjC,MAAM,UAAU,KAAK,KAAK,CAAC,KAAK,IAAI,IAAI,CAAC,KAAK,CAAC;IAC/C,MAAM,cACJ,OAAO,OAAO,MAAM,EAAE,gBAAgB,aAClC,CAAC;QACC,OAAO,MAAM,CAAC,WAAW,CAAC,KAAK;IACjC,IACA,CAAA,GAAA,WAAA;IACN,IAAI,8CAAwB,UAAU;QACpC,MAAM,QAAE,IAAI,WAAE,OAAO,EAAE,GAAG;QAC1B,MAAM,SAAS,OAAO,IAAgC;YACpD,IAAI;gBACF,MAAM;gBACN,YAAY;oBAAE,MAAM,CAAA,EAAG,KAAI,QAAA,CAAU;gBAAA;gBACrC,gCAAU;YACZ,EAAE,OAAO,OAAO;gBACd,YAAY;oBAAE,MAAM,CAAA,EAAG,KAAI,MAAA,CAAQ;oBAAE,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG,KAAK,SAAS,CAAC;gBAAM;YAC5G;QACF;QACA,OAAQ;YACN,KAAK;gBACH,MAAM,OAAO,IAAM,8BAAQ,YAAY,CAAC,UAAU;gBAClD;YACF,KAAK;gBACH,MAAM,OAAO,IAAM,8BAAQ,YAAY,CAAC;wBAAC;qBAAQ,GAAG,CAAA,EAAG,QAAQ,QAAQ,CAAA,gEAAA,CAAU;gBACjF;YACF;gBACE;QACJ;IACF,OACE,gCAAU;AAEd;AAEA,MAAM,kCAAY,CAAC;IACjB,CAAA,GAAA,YAAA,EAAM,CAAA,EAAG,IAAG,iIAAA,CAAmB;IAC/B,WAAW;QACT,OAAO,KAAK;IACd,GAAG;AACL;AAEA","sources":["src/utils/download.ts","src/services/cross-site-handler.ts","node_modules/classic-di/dist/polyfill.browser.esm.min.js"],"sourcesContent":["export function download(url: string, filename: string) {\r\n  const link = document.createElement(\"a\");\r\n  link.download = filename;\r\n  link.href = url;\r\n  link.click();\r\n}\r\n\r\nexport function downloadJSON(json: object, filename: string) {\r\n  const url = URL.createObjectURL(new Blob([JSON.stringify(json, undefined, 2) + \"\\n\"], { type: \"application/json\" }));\r\n  download(url, filename);\r\n}\r\n","import \"classic-di/polyfill\";\r\nimport { ChartServiceImpl } from \"./chart-data\";\r\nimport { AssetsResolverImpl } from \"./assets-resolver\";\r\nimport { ArcaeaToolbeltDatabaseContext } from \"./database\";\r\nimport { CrossSiteMessageData } from \"./cross-site-protocol\";\r\nimport { alert } from \"../view/components/fancy-dialog\";\r\nimport { noop } from \"hyplate\";\r\nimport { CoreDataServiceImpl } from \"./core-data\";\r\nimport { CoreDataProviderImpl } from \"./core-data-provider\";\r\nimport { ProxyGateway } from \"./gateway\";\r\nimport { PreferenceServiceImpl } from \"./preference\";\r\nimport { Container } from \"classic-di\";\r\nimport { $ProfileService } from \"./declarations\";\r\nimport { ProfileServiceImpl } from \"./player-profile\";\r\nimport { MusicPlayServiceImpl } from \"./music-play\";\r\n\r\nconst container = new Container();\r\ncontainer.register(ArcaeaToolbeltDatabaseContext);\r\ncontainer.register(ChartServiceImpl);\r\ncontainer.register(AssetsResolverImpl);\r\ncontainer.register(CoreDataServiceImpl);\r\ncontainer.register(CoreDataProviderImpl);\r\ncontainer.register(ProxyGateway);\r\ncontainer.register(PreferenceServiceImpl);\r\ncontainer.register(ProfileServiceImpl);\r\ncontainer.register(MusicPlayServiceImpl);\r\n\r\nconst profile = container.get($ProfileService);\r\n//#region Legacy <iframe>\r\n/* localStorage和indexedDB均被标记为“第三方”，因为顶级网站不同源。目前此实现已无法工作。\r\nwindow.addEventListener(\"message\", async (e) => {\r\n  const parent = window.parent;\r\n  const data = e.data;\r\n  const type = data.type;\r\n  const payload = data.payload;\r\n  const handle = async (as: () => Promise<void> | void) => {\r\n    try {\r\n      await as();\r\n      parent.postMessage({ type: `${type}-success` }, \"*\");\r\n    } catch (error) {\r\n      parent.postMessage(\r\n        { type: `${type}-error`, error: error instanceof Error ? error.message : JSON.stringify(error) },\r\n        \"*\"\r\n      );\r\n    }\r\n  };\r\n  switch (type) {\r\n    case \"sync-profiles\":\r\n      await handle(() => profile.syncProfiles(payload));\r\n      break;\r\n    case \"sync-me\":\r\n      await handle(() => profile.syncProfiles([payload]));\r\n      break;\r\n    default:\r\n      break;\r\n  }\r\n});\r\n*/\r\n//#endregion\r\n\r\nconst isValidCrossSiteMessage = (data: unknown): data is CrossSiteMessageData => {\r\n  return data != null && typeof data === \"object\" && \"type\" in data && \"payload\" in data;\r\n};\r\n\r\n/**\r\n * 新实现，直接通过`URL#hash`传参，相比而言多了个弹窗\r\n */\r\nconst handleURL = async () => {\r\n  const url = new URL(location.href);\r\n  const message = JSON.parse(atob(url.hash.slice(1)));\r\n  const postMessage =\r\n    typeof window.opener?.postMessage === \"function\"\r\n      ? (msg: any) => {\r\n          window.opener.postMessage(msg, \"*\");\r\n        }\r\n      : noop;\r\n  if (isValidCrossSiteMessage(message)) {\r\n    const { type, payload } = message;\r\n    const handle = async (as: () => Promise<void> | void, msg: string) => {\r\n      try {\r\n        await as();\r\n        postMessage({ type: `${type}-success` });\r\n        closeWith(msg);\r\n      } catch (error) {\r\n        postMessage({ type: `${type}-error`, error: error instanceof Error ? error.message : JSON.stringify(error) });\r\n      }\r\n    };\r\n    switch (type) {\r\n      case \"sync-profiles\":\r\n        await handle(() => profile.syncProfiles(payload), \"导入存档成功\");\r\n        break;\r\n      case \"sync-me\":\r\n        await handle(() => profile.syncProfiles([payload]), `${payload.username}存档数据同步成功`);\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n  } else {\r\n    closeWith(\"地址格式不正确。\");\r\n  }\r\n};\r\n\r\nconst closeWith = (msg: string) => {\r\n  alert(`${msg}。可关闭本窗口，5秒后将自动关闭。`);\r\n  setTimeout(() => {\r\n    window.close();\r\n  }, 5000);\r\n};\r\n\r\nhandleURL();\r\n","Symbol.metadata||Object.defineProperty(Symbol,\"metadata\",{value:Symbol(\"Symbol.metadata\")});\n"],"names":[],"version":3,"file":"cross-site-frame.4844bdab.js.map"}